<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>OpenTSDB Digest：HBase 数据的写入和压缩 | 涛声依旧</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本文主要介绍 OpenTSDB 时间数据点写入 HBase 和压缩过程中的几个主要步骤，话不多说，上代码。">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenTSDB Digest：HBase 数据的写入和压缩">
<meta property="og:url" content="https://dingguitao.github.io/2015/08/01/OpenTSDB-Digest-HBase-Write-and-Row-Compaction/index.html">
<meta property="og:site_name" content="涛声依旧">
<meta property="og:description" content="本文主要介绍 OpenTSDB 时间数据点写入 HBase 和压缩过程中的几个主要步骤，话不多说，上代码。">
<meta property="og:image" content="http://7xjkvk.com1.z0.glb.clouddn.com/UID%20create%20example.png">
<meta property="og:image" content="http://7xjkvk.com1.z0.glb.clouddn.com/opentsdb_cf.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OpenTSDB Digest：HBase 数据的写入和压缩">
<meta name="twitter:description" content="本文主要介绍 OpenTSDB 时间数据点写入 HBase 和压缩过程中的几个主要步骤，话不多说，上代码。">
  
    <link rel="alternative" href="/atom.xml" title="涛声依旧" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">涛声依旧</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="q" value="site:https://dingguitao.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-OpenTSDB-Digest-HBase-Write-and-Row-Compaction" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/01/OpenTSDB-Digest-HBase-Write-and-Row-Compaction/" class="article-date">
  <time datetime="2015-08-01T08:36:20.000Z" itemprop="datePublished">2015-08-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Data-Technology/">Data Technology</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      OpenTSDB Digest：HBase 数据的写入和压缩
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文主要介绍 OpenTSDB 时间数据点写入 HBase 和压缩过程中的几个主要步骤，话不多说，上代码。</p>
<a id="more"></a>
<h2 id="1-UID_的写入">1.UID 的写入</h2><h3 id="1-1_UID_的获取和创建">1.1 UID 的获取和创建</h3><p>UID 与其代表的字符串的对应关系存放于 tsdb-uid 表，该表有两个列族：NAME 和 ID，当 OpenTSDB 接收到一个的 metric/tagk/tagv 的值的时候，会先检查在这个表中有没有对应的 UID 存在，如果有就返回对应的 UID 供后续使用，如果没有就会创建一个新的。</p>
<p><code>class: net.opentsdb.uid.UniqueId</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Deferred&lt;<span class="keyword">byte</span>[]&gt; getOrCreateIdAsync(<span class="keyword">final</span> String name) &#123;</span><br><span class="line">  <span class="comment">// Look in the cache first.</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">byte</span>[] id = getIdFromCache(name);</span><br><span class="line">  <span class="keyword">if</span> (id != <span class="keyword">null</span>) &#123;</span><br><span class="line">    cache_hits++;</span><br><span class="line">    <span class="keyword">return</span> Deferred.fromResult(id);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Not found in our cache, so look in HBase instead.</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">HandleNoSuchUniqueNameCB</span> <span class="keyword">implements</span> <span class="title">Callback</span>&lt;<span class="title">Object</span>, <span class="title">Exception</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">call</span><span class="params">(<span class="keyword">final</span> Exception e)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (e <span class="keyword">instanceof</span> NoSuchUniqueName) &#123;</span><br><span class="line">        </span><br><span class="line">        Deferred&lt;<span class="keyword">byte</span>[]&gt; assignment = <span class="keyword">null</span>;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// start the assignment dance after stashing the deferred</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UniqueIdAllocator(name, assignment).tryAllocate();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> e;  <span class="comment">// Other unexpected exception, let it bubble up.</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Kick off the HBase lookup, and if we don't find it there either, start</span></span><br><span class="line">  <span class="comment">// the process to allocate a UID.</span></span><br><span class="line">  <span class="keyword">return</span> getIdAsync(name).addErrback(<span class="keyword">new</span> HandleNoSuchUniqueNameCB());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2_新的_UID_的创建过程">1.2 新的 UID 的创建过程</h3><p>创建一个新的 UID 的步骤如下：</p>
<ul>
<li>确定 UID 的值（tsdb-uid 表的 row key 递增）</li>
<li>写入 UID 到 NAME 的对应关系，即 row key 为 UID，column family 选择 NAME，column qualifier 选择 UID 的类型（metric / tagk / tagv）</li>
<li>写入 NAME 到 UID 的对应关系，即 row key 为NAME，column family 选择 ID，column qualifier 选择 UID 的类型（metric / tagk/ tagv）</li>
<li>返回新建的 UID</li>
</ul>
<p>所以对一对 UID 和 NAME， tsdb-uid 表中存放了两条记录（如下图所示），支持按照 NAME 获取 UID 和按照 UID 获取对应类型的 NAME。</p>
<p><img src="http://7xjkvk.com1.z0.glb.clouddn.com/UID%20create%20example.png" alt="UID Create Example"></p>
<p>因为 HBase 只支持行级事务，所以这个过程中先写入 UID 到 NAME 的 mapping，这样即使后边失败了，这行数据也不会有坏的影响；反过来的话可能会导致根据 NAME 拿到的 UID 在表中并不存在。</p>
<p><code>class: net.opentsdb.uid.UniqueId</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UniqueIdAllocator</span> <span class="keyword">implements</span> <span class="title">Callback</span>&lt;<span class="title">Object</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String name;  <span class="comment">// What we're trying to allocate an ID for.</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Deferred&lt;<span class="keyword">byte</span>[]&gt; assignment; <span class="comment">// deferred to call back</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">short</span> attempt = MAX_ATTEMPTS_ASSIGN_ID;  <span class="comment">// Give up when zero.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> HBaseException hbe = <span class="keyword">null</span>;  <span class="comment">// Last exception caught.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> id = -<span class="number">1</span>;  <span class="comment">// The ID we'll grab with an atomic increment.</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">byte</span> row[];    <span class="comment">// The same ID, as a byte array.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> ALLOCATE_UID = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> CREATE_REVERSE_MAPPING = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> CREATE_FORWARD_MAPPING = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> DONE = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">byte</span> state = ALLOCATE_UID;  <span class="comment">// Current state of the process.</span></span><br><span class="line"></span><br><span class="line">  UniqueIdAllocator(<span class="keyword">final</span> String name, <span class="keyword">final</span> Deferred&lt;<span class="keyword">byte</span>[]&gt; assignment) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.assignment = assignment;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Deferred&lt;<span class="keyword">byte</span>[]&gt; tryAllocate() &#123;</span><br><span class="line">    attempt--;</span><br><span class="line">    state = ALLOCATE_UID;</span><br><span class="line">    call(<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> assignment;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">call</span><span class="params">(<span class="keyword">final</span> Object arg)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">          </span><br><span class="line">    <span class="keyword">final</span> Deferred d;</span><br><span class="line">    <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">      <span class="keyword">case</span> ALLOCATE_UID:</span><br><span class="line">        d = allocateUid();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> CREATE_REVERSE_MAPPING:</span><br><span class="line">        d = createReverseMapping(arg);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> CREATE_FORWARD_MAPPING:</span><br><span class="line">        d = createForwardMapping(arg);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> DONE:</span><br><span class="line">        <span class="keyword">return</span> done(arg);</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Should never be here!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> d.addBoth(<span class="keyword">this</span>).addErrback(<span class="keyword">new</span> ErrBack());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Deferred&lt;Long&gt; <span class="title">allocateUid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LOG.info(<span class="string">"Creating an ID for kind='"</span> + kind()</span><br><span class="line">             + <span class="string">"' name='"</span> + name + <span class="string">'\''</span>);</span><br><span class="line"></span><br><span class="line">    state = CREATE_REVERSE_MAPPING;</span><br><span class="line">    <span class="keyword">return</span> client.atomicIncrement(<span class="keyword">new</span> AtomicIncrementRequest(table, MAXID_ROW,</span><br><span class="line">                                                             ID_FAMILY,</span><br><span class="line">                                                             kind));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Deferred&lt;Boolean&gt; <span class="title">createReverseMapping</span><span class="params">(<span class="keyword">final</span> Object arg)</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    state = CREATE_FORWARD_MAPPING;</span><br><span class="line">    <span class="keyword">return</span> client.compareAndSet(reverseMapping(), HBaseClient.EMPTY_ARRAY);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> PutRequest <span class="title">reverseMapping</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PutRequest(table, row, NAME_FAMILY, kind, toBytes(name));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Deferred&lt;?&gt; createForwardMapping(<span class="keyword">final</span> Object arg) &#123;</span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    state = DONE;</span><br><span class="line">    <span class="keyword">return</span> client.compareAndSet(forwardMapping(), HBaseClient.EMPTY_ARRAY);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> PutRequest <span class="title">forwardMapping</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> PutRequest(table, toBytes(name), ID_FAMILY, kind, row);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Deferred&lt;<span class="keyword">byte</span>[]&gt; done(<span class="keyword">final</span> Object arg) &#123;</span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-_数据点的写入">2. 数据点的写入</h2><h3 id="2-1_生成单个数据点的_Row_Key_模板">2.1 生成单个数据点的 Row Key 模板</h3><p>根据数据点的 metric 和 tags 生成 row key 的 byte 数组，byte 数组的顺序是：metric_id, timestamp, tag key 1, tag value 1, tag key 2, tag value 2, … 。其中 timestamp 部分的值未设置，tag 部分是排过序的。</p>
<p><code>class: net.opentsdb.core.IncomingDataPoints</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="javadoc">/**</span><br><span class="line"> * Returns a partially initialized row key for this metric and these tags.</span><br><span class="line"> * The only thing left to fill in is the base timestamp.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">byte</span>[] rowKeyTemplate(<span class="keyword">final</span> TSDB tsdb,</span><br><span class="line">                              <span class="keyword">final</span> String metric,</span><br><span class="line">                              <span class="keyword">final</span> Map&lt;String, String&gt; tags) &#123;</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">short</span> metric_width = tsdb.metrics.width();</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">short</span> tag_name_width = tsdb.tag_names.width();</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">short</span> tag_value_width = tsdb.tag_values.width();</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">short</span> num_tags = (<span class="keyword">short</span>) tags.size();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> row_size = (metric_width + Const.TIMESTAMP_BYTES</span><br><span class="line">                   + tag_name_width * num_tags</span><br><span class="line">                   + tag_value_width * num_tags);</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">byte</span>[] row = <span class="keyword">new</span> <span class="keyword">byte</span>[row_size];</span><br><span class="line"></span><br><span class="line">   <span class="keyword">short</span> pos = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   copyInRowKey(row, pos, (tsdb.config.auto_metric() ? </span><br><span class="line">       tsdb.metrics.getOrCreateId(metric) : tsdb.metrics.getId(metric)));</span><br><span class="line">   pos += metric_width;</span><br><span class="line"></span><br><span class="line">   pos += Const.TIMESTAMP_BYTES;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span>(<span class="keyword">final</span> <span class="keyword">byte</span>[] tag : Tags.resolveOrCreateAll(tsdb, tags)) &#123;</span><br><span class="line">     copyInRowKey(row, pos, tag);</span><br><span class="line">     pos += tag.length;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> row;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2_生成单个数据点的_Column_Qualifier">2.2 生成单个数据点的 Column Qualifier</h3><p>根据 timestamp 生成 column qualifier 的 byte 数组，timestamp 的单位是秒和毫秒的时候，返回的数组的长度分别是 2 和 4。</p>
<p>column qualifier 由两部分组成：第一部分代表该数据点与上一个整点的时间差，第二部分（最后四位）代表该数据点值的数据类型，byte、short、int、long、float、double类型对应的分别是：0000、0001、0011、0111、1011、1111。如下图所示：</p>
<p><img src="http://7xjkvk.com1.z0.glb.clouddn.com/opentsdb_cf.png" alt="OpenTSDB Column Qualifier"></p>
<p><code>class: net.opentsdb.core.Internal</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="javadoc">/**</span><br><span class="line">  * Returns a 2 or 4 byte qualifier based on the timestamp and the flags. If</span><br><span class="line">  * the timestamp is in seconds, this returns a 2 byte qualifier. If it's in</span><br><span class="line">  * milliseconds, returns a 4 byte qualifier </span><br><span class="line">  *<span class="javadoctag"> @param</span> timestamp A Unix epoch timestamp in seconds or milliseconds</span><br><span class="line">  *<span class="javadoctag"> @param</span> flags Flags to set on the qualifier (length &amp;| float)</span><br><span class="line">  *<span class="javadoctag"> @return</span> A 2 or 4 byte qualifier for storage in column or compacted column</span><br><span class="line">  *<span class="javadoctag"> @since</span> 2.0</span><br><span class="line">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] buildQualifier(<span class="keyword">final</span> <span class="keyword">long</span> timestamp, <span class="keyword">final</span> <span class="keyword">short</span> flags) &#123;</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">long</span> base_time;</span><br><span class="line">   <span class="keyword">if</span> ((timestamp &amp; Const.SECOND_MASK) != <span class="number">0</span>) &#123;</span><br><span class="line">     <span class="comment">// drop the ms timestamp to seconds to calculate the base timestamp</span></span><br><span class="line">     base_time = ((timestamp / <span class="number">1000</span>) - ((timestamp / <span class="number">1000</span>) </span><br><span class="line">         % Const.MAX_TIMESPAN));</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">int</span> qual = (<span class="keyword">int</span>) (((timestamp - (base_time * <span class="number">1000</span>) </span><br><span class="line">         &lt;&lt; (Const.MS_FLAG_BITS)) | flags) | Const.MS_FLAG);</span><br><span class="line">     <span class="keyword">return</span> Bytes.fromInt(qual);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     base_time = (timestamp - (timestamp % Const.MAX_TIMESPAN));</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">short</span> qual = (<span class="keyword">short</span>) ((timestamp - base_time) &lt;&lt; Const.FLAG_BITS</span><br><span class="line">         | flags);</span><br><span class="line">     <span class="keyword">return</span> Bytes.fromShort(qual);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3_写入单个数据点">2.3 写入单个数据点</h3><p>写入一个数据点，会生成该数据点的 row key、column qualifier，然后发送写入 HBase 的请求，并将此数据点加入到 OpenTSDB 自身的 compaction 队列中，OpenTSDB 的 compaction 与 HBase 的 compaction 是两回事。</p>
<p>可以看出，对于同一个 metric，如果 tags 这部分相同，那么同一个小时的数据点的 row key 也是相同的。</p>
<p><code>class: net.opentsdb.core.TSDB</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Deferred&lt;Object&gt; <span class="title">addPointInternal</span><span class="params">(<span class="keyword">final</span> String metric,</span><br><span class="line">                                           <span class="keyword">final</span> <span class="keyword">long</span> timestamp,</span><br><span class="line">                                           <span class="keyword">final</span> <span class="keyword">byte</span>[] value,</span><br><span class="line">                                           <span class="keyword">final</span> Map&lt;String, String&gt; tags,</span><br><span class="line">                                           <span class="keyword">final</span> <span class="keyword">short</span> flags)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// we only accept positive unix epoch timestamps in seconds or milliseconds</span></span><br><span class="line">   <span class="keyword">if</span> (timestamp &lt; <span class="number">0</span> || ((timestamp &amp; Const.SECOND_MASK) != <span class="number">0</span> &amp;&amp; </span><br><span class="line">       timestamp &gt; <span class="number">9999999999999L</span>)) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException((timestamp &lt; <span class="number">0</span> ? <span class="string">"negative "</span> : <span class="string">"bad"</span>)</span><br><span class="line">         + <span class="string">" timestamp="</span> + timestamp</span><br><span class="line">         + <span class="string">" when trying to add value="</span> + Arrays.toString(value) + <span class="string">'/'</span> + flags</span><br><span class="line">         + <span class="string">" to metric="</span> + metric + <span class="string">", tags="</span> + tags);</span><br><span class="line">   &#125;</span><br><span class="line">   IncomingDataPoints.checkMetricAndTags(metric, tags);</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">byte</span>[] row = IncomingDataPoints.rowKeyTemplate(<span class="keyword">this</span>, metric, tags);</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">long</span> base_time;</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">byte</span>[] qualifier = Internal.buildQualifier(timestamp, flags);</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">if</span> ((timestamp &amp; Const.SECOND_MASK) != <span class="number">0</span>) &#123;</span><br><span class="line">     <span class="comment">// drop the ms timestamp to seconds to calculate the base timestamp</span></span><br><span class="line">     base_time = ((timestamp / <span class="number">1000</span>) - </span><br><span class="line">         ((timestamp / <span class="number">1000</span>) % Const.MAX_TIMESPAN));</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     base_time = (timestamp - (timestamp % Const.MAX_TIMESPAN));</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   Bytes.setInt(row, (<span class="keyword">int</span>) base_time, metrics.width());</span><br><span class="line">   scheduleForCompaction(row, (<span class="keyword">int</span>) base_time);</span><br><span class="line">   <span class="keyword">final</span> PutRequest point = <span class="keyword">new</span> PutRequest(table, row, FAMILY, qualifier, value);</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// TODO(tsuna): Add a callback to time the latency of HBase and store the</span></span><br><span class="line">   <span class="comment">// timing in a moving Histogram (once we have a class for this).</span></span><br><span class="line">   Deferred&lt;Object&gt; result = client.put(point);</span><br><span class="line">   <span class="keyword">if</span> (!config.enable_realtime_ts() &amp;&amp; !config.enable_tsuid_incrementing() &amp;&amp; </span><br><span class="line">       !config.enable_tsuid_tracking() &amp;&amp; rt_publisher == <span class="keyword">null</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">byte</span>[] tsuid = UniqueId.getTSUIDFromKey(row, METRICS_WIDTH, </span><br><span class="line">       Const.TIMESTAMP_BYTES);</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// for busy TSDs we may only enable TSUID tracking, storing a 1 in the</span></span><br><span class="line">   <span class="comment">// counter field for a TSUID with the proper timestamp. If the user would</span></span><br><span class="line">   <span class="comment">// rather have TSUID incrementing enabled, that will trump the PUT</span></span><br><span class="line">   <span class="keyword">if</span> (config.enable_tsuid_tracking() &amp;&amp; !config.enable_tsuid_incrementing()) &#123;</span><br><span class="line">     <span class="keyword">final</span> PutRequest tracking = <span class="keyword">new</span> PutRequest(meta_table, tsuid, </span><br><span class="line">         TSMeta.FAMILY(), TSMeta.COUNTER_QUALIFIER(), Bytes.fromLong(<span class="number">1</span>));</span><br><span class="line">     client.put(tracking);</span><br><span class="line">   &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(config.enable_tsuid_incrementing()</span> || config.<span class="title">enable_realtime_ts</span><span class="params">()</span>) </span>&#123;</span><br><span class="line">     TSMeta.incrementAndGetCounter(TSDB.<span class="keyword">this</span>, tsuid);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">if</span> (rt_publisher != <span class="keyword">null</span>) &#123;</span><br><span class="line">     rt_publisher.sinkDataPoint(metric, timestamp, value, tags, tsuid, flags);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> result;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-_数据点的压缩">3. 数据点的压缩</h2><h3 id="3-1_将所有数据点加载到内存">3.1 将所有数据点加载到内存</h3><p>将队列中的所有数据点转成 ColumnDatapointIterator 类型，然后存放在一个 ArrayList 中，方便后续的操作。</p>
<p>从 ColumnDatapointIterator 类的定义看，这里的数据点可以是单个数据点，也可以是之前压缩过的数据点。</p>
<p><code>class: net.opentsdb.core</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="javadoc">/**</span><br><span class="line">    * Build a heap of columns containing datapoints.  Assumes that non-datapoint columns are</span><br><span class="line">    * never merged.  Adds datapoint columns to the list of rows to be deleted.</span><br><span class="line">    *</span><br><span class="line">    *<span class="javadoctag"> @return</span> an estimate of the number of total values present, which may be high</span><br><span class="line">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">buildHeapProcessAnnotations</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">int</span> tot_values = <span class="number">0</span>;</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">final</span> KeyValue kv : row) &#123;</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">byte</span>[] qual = kv.qualifier();</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> len = qual.length;</span><br><span class="line">       <span class="keyword">if</span> ((len &amp; <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">// process annotations and other extended formats</span></span><br><span class="line">         <span class="keyword">if</span> (qual[<span class="number">0</span>] == Annotation.PREFIX()) &#123;</span><br><span class="line">           annotations.add(JSON.parseToObject(kv.value(), Annotation.class));</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           LOG.warn(<span class="string">"Ignoring unexpected extended format type "</span> + qual[<span class="number">0</span>]);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">continue</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// estimate number of points based on the size of the first entry</span></span><br><span class="line">       <span class="comment">// in the column; if ms/sec datapoints are mixed, this will be</span></span><br><span class="line">       <span class="comment">// incorrect, which will cost a reallocation/copy</span></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> entry_size = Internal.inMilliseconds(qual) ? <span class="number">4</span> : <span class="number">2</span>;</span><br><span class="line">       tot_values += (len + entry_size - <span class="number">1</span>) / entry_size;</span><br><span class="line">       <span class="keyword">if</span> (longest == <span class="keyword">null</span> || longest.qualifier().length &lt; kv.qualifier().length) &#123;</span><br><span class="line">         longest = kv;</span><br><span class="line">       &#125;</span><br><span class="line">       ColumnDatapointIterator col = <span class="keyword">new</span> ColumnDatapointIterator(kv);</span><br><span class="line">       <span class="keyword">if</span> (col.hasMoreData()) &#123;</span><br><span class="line">         heap.add(col);</span><br><span class="line">       &#125;</span><br><span class="line">       to_delete.add(kv);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> tot_values;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2_将所有的数据点合并到一个列表中">3.2 将所有的数据点合并到一个列表中</h3><p>对所有需要压缩的数据点，创建两个 ByteBufferList，分别存放这些数据点的 column qualifier 和对应的 column value。</p>
<p>如果是之前压缩过的数据点，在这一步会被重新打散成单个数据点。</p>
<p><code>class: net.opentsdb.core</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="javadoc">/**</span><br><span class="line"> * Process datapoints from the heap in order, merging into a sorted list.  Handles duplicates</span><br><span class="line"> * by keeping the most recent (based on HBase column timestamps; if duplicates in the )</span><br><span class="line"> *</span><br><span class="line"> *<span class="javadoctag"> @param</span> compacted_qual qualifiers for sorted datapoints</span><br><span class="line"> *<span class="javadoctag"> @param</span> compacted_val values for sorted datapoints</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mergeDatapoints</span><span class="params">(ByteBufferList compacted_qual, ByteBufferList compacted_val)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> prevTs = -<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> (!heap.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">final</span> ColumnDatapointIterator col = heap.remove();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> ts = col.getTimestampOffsetMs();</span><br><span class="line">    <span class="keyword">if</span> (ts == prevTs) &#123;</span><br><span class="line">      <span class="comment">// check to see if it is a complete duplicate, or if the value changed</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">byte</span>[] existingVal = compacted_val.getLastSegment();</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">byte</span>[] discardedVal = col.getCopyOfCurrentValue();</span><br><span class="line">      <span class="keyword">if</span> (!Arrays.equals(existingVal, discardedVal)) &#123;</span><br><span class="line">        duplicates_different.incrementAndGet();</span><br><span class="line">        <span class="keyword">if</span> (!tsdb.config.fix_duplicates()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalDataException(<span class="string">"Duplicate timestamp for key="</span></span><br><span class="line">              + Arrays.toString(row.get(<span class="number">0</span>).key()) + <span class="string">", ms_offset="</span> + ts + <span class="string">", older="</span></span><br><span class="line">              + Arrays.toString(existingVal) + <span class="string">", newer="</span> + Arrays.toString(discardedVal)</span><br><span class="line">              + <span class="string">"; set tsd.storage.fix_duplicates=true to fix automatically or run Fsck"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.warn(<span class="string">"Duplicate timestamp for key="</span> + Arrays.toString(row.get(<span class="number">0</span>).key())</span><br><span class="line">            + <span class="string">", ms_offset="</span> + ts + <span class="string">", kept="</span> + Arrays.toString(existingVal) + <span class="string">", discarded="</span></span><br><span class="line">            + Arrays.toString(discardedVal));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        duplicates_same.incrementAndGet();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      prevTs = ts;</span><br><span class="line">      col.writeToBuffers(compacted_qual, compacted_val);</span><br><span class="line">      ms_in_row |= col.isMilliseconds();</span><br><span class="line">      s_in_row |= !col.isMilliseconds();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (col.advance()) &#123;</span><br><span class="line">      <span class="comment">// there is still more data in this column, so add it back to the heap</span></span><br><span class="line">      heap.add(col);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-3_从合并后的列表中得到压缩后的数据点">3.3 从合并后的列表中得到压缩后的数据点</h2><p>将上一步得到的两个 ByteBufferList 转换成 byte 数组，便得到了压缩后单个数据点的 column qualifier 和 column value。转换的逻辑也非常简单，就是简单的拼接。例如：</p>
<p>压缩前：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">数据点 1：qualifier = <span class="command">\xA</span>0<span class="command">\xA</span>0    value = <span class="command">\x</span>10</span><br><span class="line">数据点 2: qualifier = <span class="command">\xBD</span><span class="command">\xB</span>0    value = <span class="command">\x</span>11</span><br></pre></td></tr></table></figure>
<p>压缩后：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">数据点：qualifier = <span class="command">\xA</span>0<span class="command">\xA</span>0<span class="command">\xBD</span><span class="command">\xB</span>0    value = <span class="command">\x</span>10<span class="command">\x</span>11</span><br></pre></td></tr></table></figure>
<p>如果压缩前的数据点中秒级和毫秒级数据都有的话，value 后边还会加一位 flag 来标识一下。</p>
<p><code>class: net.opentsdb.core</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="javadoc">/**</span><br><span class="line"> * Build the compacted column from the list of byte buffers that were</span><br><span class="line"> * merged together.</span><br><span class="line"> *</span><br><span class="line"> *<span class="javadoctag"> @param</span> compacted_qual list of merged qualifiers</span><br><span class="line"> *<span class="javadoctag"> @param</span> compacted_val list of merged values</span><br><span class="line"> *</span><br><span class="line"> *<span class="javadoctag"> @return</span> &#123;@link KeyValue&#125; instance for the compacted column</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> KeyValue <span class="title">buildCompactedColumn</span><span class="params">(ByteBufferList compacted_qual,</span><br><span class="line">    ByteBufferList compacted_val)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// metadata is a single byte for a multi-value column, otherwise nothing</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> metadata_length = compacted_val.segmentCount() &gt; <span class="number">1</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">byte</span>[] cq = compacted_qual.toBytes(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">byte</span>[] cv = compacted_val.toBytes(metadata_length);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// add the metadata flag, which right now only includes whether we mix s/ms datapoints</span></span><br><span class="line">  <span class="keyword">if</span> (metadata_length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">byte</span> metadata_flag = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ms_in_row &amp;&amp; s_in_row) &#123;</span><br><span class="line">      metadata_flag |= Const.MS_MIXED_COMPACT;</span><br><span class="line">    &#125;</span><br><span class="line">    cv[cv.length - <span class="number">1</span>] = metadata_flag;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> KeyValue first = row.get(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> KeyValue(first.key(), first.family(), cq, cv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://dingguitao.github.io/2015/08/01/OpenTSDB-Digest-HBase-Write-and-Row-Compaction/" data-id="cih460tmy0017z7s6dxkl1411" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Compaction/">Compaction</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HBase/">HBase</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenTSDB/">OpenTSDB</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/09/01/OpenTSDB-Digest-HBase-Read/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          OpenTSDB Digest：HBase 数据的读取
        
      </div>
    </a>
  
  
    <a href="/2015/07/21/qhh/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">青海湖婚纱照＋环湖骑行</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Technology/">Data Technology</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kiong/">Kiong</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Architecture/">Architecture</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Avatica/">Avatica</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Compaction/">Compaction</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cycling/">Cycling</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Encoding/">Encoding</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Feature-Construction/">Feature Construction</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Feature-Engineering/">Feature Engineering</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Feature-Extraction/">Feature Extraction</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HBase/">HBase</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HFile/">HFile</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hive/">Hive</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jetty/">Jetty</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenTSDB/">OpenTSDB</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Phoenix/">Phoenix</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL-on-HBase/">SQL on HBase</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Time-Series-Database/">Time Series Database</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Travel/">Travel</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Architecture/" style="font-size: 10px;">Architecture</a><a href="/tags/Avatica/" style="font-size: 12.5px;">Avatica</a><a href="/tags/Compaction/" style="font-size: 10px;">Compaction</a><a href="/tags/Cycling/" style="font-size: 10px;">Cycling</a><a href="/tags/Encoding/" style="font-size: 10px;">Encoding</a><a href="/tags/Feature-Construction/" style="font-size: 10px;">Feature Construction</a><a href="/tags/Feature-Engineering/" style="font-size: 10px;">Feature Engineering</a><a href="/tags/Feature-Extraction/" style="font-size: 10px;">Feature Extraction</a><a href="/tags/HBase/" style="font-size: 20px;">HBase</a><a href="/tags/HFile/" style="font-size: 10px;">HFile</a><a href="/tags/Hive/" style="font-size: 10px;">Hive</a><a href="/tags/Jetty/" style="font-size: 10px;">Jetty</a><a href="/tags/OpenTSDB/" style="font-size: 15px;">OpenTSDB</a><a href="/tags/Phoenix/" style="font-size: 17.5px;">Phoenix</a><a href="/tags/SQL-on-HBase/" style="font-size: 10px;">SQL on HBase</a><a href="/tags/Time-Series-Database/" style="font-size: 10px;">Time Series Database</a><a href="/tags/Travel/" style="font-size: 10px;">Travel</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">五月 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">一月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">十二月 2012</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/09/22/An-In-Depth-Look-at-the-HBase-Architecture/">[译] HBase 架构总览</a>
          </li>
        
          <li>
            <a href="/2015/09/01/OpenTSDB-Digest-HBase-Read/">OpenTSDB Digest：HBase 数据的读取</a>
          </li>
        
          <li>
            <a href="/2015/08/01/OpenTSDB-Digest-HBase-Write-and-Row-Compaction/">OpenTSDB Digest：HBase 数据的写入和压缩</a>
          </li>
        
          <li>
            <a href="/2015/07/21/qhh/">青海湖婚纱照＋环湖骑行</a>
          </li>
        
          <li>
            <a href="/2015/07/01/OpenTSDB-Digest-time-series-data-table-design-on-hbase/">OpenTSDB Digest: HBase 中时间序列数据表的设计</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 Ding Guitao<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>